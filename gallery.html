<script>
    const API_KEY = '039303a80a219679c951ccf37548704f';

    // 添加照片到画廊
    function addPhotoToGallery(imageUrl) {
        // 检查是否已存在该图片
        const existingImages = document.querySelectorAll('.photo-card img');
        for (let img of existingImages) {
            if (img.src === imageUrl) {
                return; // 如果图片已存在，直接返回
            }
        }

        const gallery = document.getElementById('gallery');
        const photoCard = document.createElement('div');
        photoCard.className = 'photo-card';
        
        const img = document.createElement('img');
        img.src = imageUrl;
        img.alt = '照片';
        
        photoCard.appendChild(img);
        gallery.insertBefore(photoCard, gallery.firstChild);
    }

    // 保存照片URL（确保不重复）
    function savePhotoUrl(imageUrl) {
        let urls = JSON.parse(localStorage.getItem('photoUrls') || '[]');
        if (!urls.includes(imageUrl)) {  // 只有当URL不存在时才添加
            urls.unshift(imageUrl);
            localStorage.setItem('photoUrls', JSON.stringify(urls));
        }
    }

    // 上传照片
    async function uploadPhoto(file) {
        const formData = new FormData();
        formData.append('image', file);

        try {
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (data.success) {
                const imageUrl = data.data.url;
                addPhotoToGallery(imageUrl);
                savePhotoUrl(imageUrl);
            }
        } catch (error) {
            console.error('Upload error:', error);
        }
    }

    // 加载保存的照片（只加载一次）
    function loadSavedPhotos() {
        const urls = JSON.parse(localStorage.getItem('photoUrls') || '[]');
        // 清除现有的照片
        document.getElementById('gallery').innerHTML = '';
        // 添加保存的照片
        urls.forEach(url => addPhotoToGallery(url));
    }

    // 事件监听
    document.getElementById('uploadBtn').addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            uploadPhoto(file);
        }
    });

    // 页面加载时只加载一次照片
    window.addEventListener('load', loadSavedPhotos);
</script>
