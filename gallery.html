<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>傻球球笨多乐的相册</title>
    <style>
        /* 保持原有样式不变 */
    </style>
</head>
<body>
    <div class="header">
        <h1>✨ 傻球球笨多乐的相册 ✨</h1>
        <input type="file" id="fileInput" accept="image/*" multiple style="display: none">
        <button id="uploadBtn">添加新照片</button>
        <div id="uploadStatus"></div>
    </div>

    <div class="gallery" id="gallery"></div>

    <script>
        const API_KEY = '039303a80a219679c951ccf37548704f';
        let db;

        // 初始化数据库
        const request = indexedDB.open('PhotoGallery', 1);

        request.onerror = (event) => {
            console.error('数据库错误:', event.target.error);
        };

        request.onupgradeneeded = (event) => {
            db = event.target.result;
            if (!db.objectStoreNames.contains('photos')) {
                db.createObjectStore('photos', { keyPath: 'id', autoIncrement: true });
            }
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            loadPhotos(); // 加载照片
        };

        // 保存照片到数据库
        function savePhoto(imageUrl) {
            const transaction = db.transaction(['photos'], 'readwrite');
            const store = transaction.objectStore('photos');
            
            const photo = {
                url: imageUrl,
                timestamp: new Date().getTime()
            };
            
            store.add(photo);
        }

        // 从数据库加载照片
        function loadPhotos() {
            const transaction = db.transaction(['photos'], 'readonly');
            const store = transaction.objectStore('photos');
            const request = store.getAll();

            request.onsuccess = () => {
                const photos = request.result;
                // 按时间戳排序，最新的在前
                photos.sort((a, b) => b.timestamp - a.timestamp);
                
                const gallery = document.getElementById('gallery');
                gallery.innerHTML = ''; // 清空现有内容
                
                photos.forEach(photo => {
                    const photoCard = document.createElement('div');
                    photoCard.className = 'photo-card';
                    
                    const img = document.createElement('img');
                    img.src = photo.url;
                    img.alt = '照片';
                    
                    photoCard.appendChild(img);
                    gallery.appendChild(photoCard);
                });
            };
        }

        // 上传照片
        async function uploadPhoto(file) {
            const status = document.getElementById('uploadStatus');
            status.textContent = '上传中...';

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    const imageUrl = result.data.display_url;
                    
                    // 保存到数据库
                    savePhoto(imageUrl);
                    
                    // 重新加载所有照片
                    loadPhotos();
                    
                    status.textContent = '上传成功！';
                } else {
                    throw new Error('上传失败');
                }
            } catch (error) {
                console.error('上传错误:', error);
                status.textContent = '上传失败，请重试';
            }
        }

        // 事件监听
        document.getElementById('uploadBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => uploadPhoto(file));
        });
    </script>
</body>
</html>
